name: package

on:
  workflow_dispatch:

concurrency:
  group: deploy-pipboot
  cancel-in-progress: true

env:
  APP_IMAGE: ${{ secrets.APP_IMAGE || vars.APP_IMAGE }}
  APP_VERSION: ${{ secrets.APP_VERSION || vars.APP_VERSION }}
  APP_NAME: ${{ secrets.APP_NAME || vars.APP_NAME }}
  APP_RESOURCES: ${{ secrets.APP_RESOURCES || vars.APP_RESOURCES }}
  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
  SSH_HOST: ${{ secrets.SSH_HOST }}

jobs:
  package:
    name: package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Build Docker image
        run: |
          docker build -t ${APP_IMAGE}:${APP_VERSION} .

      - name: Save Docker image as tarball
        run: |
          docker save ${APP_IMAGE}:${APP_VERSION} -o ${APP_IMAGE}_${APP_VERSION}.tar

      - name: Debug variables (runner)
        run: |
          echo "APP_IMAGE=$APP_IMAGE"
          echo "APP_VERSION=$APP_VERSION"
          echo "APP_NAME=$APP_NAME"
          echo "APP_RESOURCES=$APP_RESOURCES"
          echo "vars.APP_IMAGE=${{ vars.APP_IMAGE }}"
          echo "vars.APP_VERSION=${{ vars.APP_VERSION }}"
          echo "vars.APP_NAME=${{ vars.APP_NAME }}"
          echo "vars.APP_RESOURCES=${{ vars.APP_RESOURCES }}"

      - name: Validate required variables (runner)
        run: |
          set -euo pipefail
          missing=()
          for v in APP_IMAGE APP_VERSION APP_NAME; do
            if [ -z "${!v:-}" ]; then missing+=("$v"); fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "ERROR: Missing variables: ${missing[*]}" >&2
            exit 1
          fi
          echo "All required variables present."

      - name: Prepare SSH key from secret
        run: |
          KEY_FILE="$RUNNER_TEMP/ssh_key"
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "KEY_FILE=$KEY_FILE" >> $GITHUB_ENV

      - name: Transfer image to EC2
        run: |
          scp -i "$KEY_FILE" -o StrictHostKeyChecking=no ${APP_IMAGE}_${APP_VERSION}.tar ${SSH_USERNAME}@${SSH_HOST}:/home/${SSH_USERNAME}/${APP_IMAGE}_${APP_VERSION}.tar

      - name: Load image on EC2
        run: |
          ssh -i "$KEY_FILE" -o StrictHostKeyChecking=no ${SSH_USERNAME}@${SSH_HOST} \
            "sudo docker load -i /home/${SSH_USERNAME}/${APP_IMAGE}_${APP_VERSION}.tar && rm -f /home/${SSH_USERNAME}/${APP_IMAGE}_${APP_VERSION}.tar && sudo docker images | grep ${APP_IMAGE}"

      - name: Create remote run script
        run: |
          # Generate a pre-expanded remote script (variables expand here on runner)
          cat > "$RUNNER_TEMP/remote_deploy.sh" <<EOF
          set -euo pipefail
          NAME="${APP_NAME}"
          IMG="${APP_IMAGE}:${APP_VERSION}"
          RES="${APP_RESOURCES:-}"
          if [ -z "${APP_RESOURCES:-}" ]; then
            echo "WARNING: APP_RESOURCES empty. Using default /opt/docker/pip/resources." >&2
            RES=/opt/docker/pip/resources
          fi

          echo "[remote] NAME=$NAME"
          echo "[remote] IMG=$IMG"
          echo "[remote] RES=$RES"

          if [ -z "$NAME" ] || [ -z "$IMG" ]; then
            echo "ERROR: NAME or IMG is empty." >&2
            exit 1
          fi

          if ! command -v docker >/dev/null 2>&1; then
            echo "ERROR: docker not found on remote host." >&2
            exit 1
          fi

          sudo mkdir -p "$RES"

          # Remove existing container with same name
          if sudo docker ps -a --format '{{.Names}}' | grep -wq "$NAME"; then
            echo "[remote] Removing existing container $NAME"
            sudo docker rm -f "$NAME" || true
          fi

          echo "[remote] Starting container: $NAME -> $IMG"
          sudo docker run -d --name "$NAME" -p 3030:3030 -v "$RES":/opt/app/resources --restart unless-stopped "$IMG"
          sudo docker ps --filter name="$NAME" --format "running: {{.Names}} -> {{.Image}}"
          EOF
          # Show script for debugging
          echo "------ remote_deploy.sh (rendered) ------"
          sed -e 's/.*/    &/' "$RUNNER_TEMP/remote_deploy.sh"
          echo "-----------------------------------------"
          chmod 700 "$RUNNER_TEMP/remote_deploy.sh"

      - name: Upload and run on EC2
        run: |
          scp -i "$KEY_FILE" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$RUNNER_TEMP/remote_deploy.sh" ${SSH_USERNAME}@${SSH_HOST}:/home/${SSH_USERNAME}/remote_deploy.sh
          ssh -i "$KEY_FILE" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${SSH_USERNAME}@${SSH_HOST} "bash -lc 'sudo bash /home/${SSH_USERNAME}/remote_deploy.sh'"
