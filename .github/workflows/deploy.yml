name: package

on:
  workflow_dispatch:

concurrency:
  group: deploy-pipboot
  cancel-in-progress: true

env:
  APP_IMAGE: ${{ secrets.APP_IMAGE || vars.APP_IMAGE }}
  APP_VERSION: ${{ secrets.APP_VERSION || vars.APP_VERSION }}
  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
  SSH_HOST: ${{ secrets.SSH_HOST }}

jobs:
  package:
    name: package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '8'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Build Docker image
        run: |
          docker build -t ${APP_IMAGE}:${APP_VERSION} .

      - name: Save Docker image as tarball
        run: |
          docker save ${APP_IMAGE}:${APP_VERSION} -o ${APP_IMAGE}_${APP_VERSION}.tar

      - name: Prepare SSH key from secret
        run: |
          KEY_FILE="$RUNNER_TEMP/ssh_key"
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "KEY_FILE=$KEY_FILE" >> $GITHUB_ENV

      - name: Transfer image to EC2
        run: |
          scp -i "$KEY_FILE" -o StrictHostKeyChecking=no ${APP_IMAGE}_${APP_VERSION}.tar ${SSH_USERNAME}@${SSH_HOST}:/home/${SSH_USERNAME}/${APP_IMAGE}_${APP_VERSION}.tar

      - name: Load image on EC2
        run: |
          ssh -i "$KEY_FILE" -o StrictHostKeyChecking=no ${SSH_USERNAME}@${SSH_HOST} \
            "sudo docker load -i /home/${SSH_USERNAME}/${APP_IMAGE}_${APP_VERSION}.tar && rm -f /home/${SSH_USERNAME}/${APP_IMAGE}_${APP_VERSION}.tar && sudo docker images | grep ${APP_IMAGE}"
